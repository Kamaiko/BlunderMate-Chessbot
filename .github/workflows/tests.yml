name: Prolog Chess CI Pipeline

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

# ğŸ›¡ï¸ PIPELINE PROFESSIONNEL MULTICOUCHE
jobs:
  # ===================================================================
  # PHASE 1: VALIDATION ENVIRONNEMENT
  # ===================================================================
  environment-validation:
    name: "Environment Setup & Validation"
    runs-on: ubuntu-latest
    container: swipl:latest
    timeout-minutes: 3

    outputs:
      prolog-version: ${{ steps.prolog-info.outputs.version }}
      setup-status: ${{ steps.setup-check.outputs.status }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: Validate SWI-Prolog Installation
      id: prolog-info
      timeout-minutes: 1
      run: |
        echo "=== PROLOG ENVIRONMENT VALIDATION ==="
        PROLOG_VERSION=$(timeout 15s swipl --version | head -1)
        echo "version=$PROLOG_VERSION" >> $GITHUB_OUTPUT
        echo "âœ“ SWI-Prolog: $PROLOG_VERSION"

    - name: Verify Project Structure
      id: setup-check
      timeout-minutes: 1
      run: |
        echo "=== PROJECT STRUCTURE VALIDATION ==="
        timeout 30s bash -c '
          echo "ğŸ“ Source files:"
          ls -la src/ | grep "\.pl$" || echo "No .pl files found"
          echo "ğŸ§ª Test files:"
          ls -la tests/ | grep "\.pl$" || echo "No test files found"
          echo "ğŸ“š Documentation:"
          ls -la docs/ | grep "\.md$" || echo "No documentation found"
        '
        echo "status=success" >> $GITHUB_OUTPUT
        echo "âœ“ Project structure validated"

  # ===================================================================
  # PHASE 2: TESTS FONDAMENTAUX (RAPIDES)
  # ===================================================================
  foundation-tests:
    name: "Foundation & Core Logic Tests"
    runs-on: ubuntu-latest
    container: swipl:latest
    timeout-minutes: 5
    needs: environment-validation

    strategy:
      fail-fast: false
      matrix:
        test-suite: [foundation, game-rules, robustness]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: Run ${{ matrix.test-suite }} Tests
      timeout-minutes: 3
      run: |
        echo "=== ${{ matrix.test-suite | upper }} TESTS ==="
        case "${{ matrix.test-suite }}" in
          "foundation")
            timeout 120s swipl -s tests/tests.pl -g "run_foundation_tests, halt." || exit 1
            ;;
          "game-rules")
            timeout 120s swipl -s tests/tests.pl -g "run_game_rules_tests, halt." || exit 1
            ;;
          "robustness")
            timeout 90s swipl -s tests/tests.pl -g "run_robustness_tests, halt." || exit 1
            ;;
        esac
        echo "âœ“ ${{ matrix.test-suite }} tests completed successfully"

  # ===================================================================
  # PHASE 3: TESTS INTELLIGENCE ARTIFICIELLE (AVANCÃ‰S)
  # ===================================================================
  ai-tests:
    name: "AI & Algorithm Tests"
    runs-on: ubuntu-latest
    container: swipl:latest
    timeout-minutes: 8
    needs: foundation-tests

    strategy:
      fail-fast: false
      matrix:
        ai-component: [algorithms, evaluation, tactical]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: Run AI ${{ matrix.ai-component }} Tests
      timeout-minutes: 5
      run: |
        echo "=== AI ${{ matrix.ai-component | upper }} TESTS ==="
        case "${{ matrix.ai-component }}" in
          "algorithms")
            timeout 240s swipl -s tests/tests.pl -g "run_ai_algorithm_tests, halt." || exit 1
            ;;
          "evaluation")
            timeout 180s swipl -s tests/tests.pl -g "run_ai_evaluation_tests, halt." || exit 1
            ;;
          "tactical")
            timeout 180s swipl -s tests/tests.pl -g "run_tactical_tests, halt." || exit 1
            ;;
        esac
        echo "âœ“ AI ${{ matrix.ai-component }} tests completed successfully"

  # ===================================================================
  # PHASE 4: TESTS D'INTÃ‰GRATION & SYSTÃˆME
  # ===================================================================
  integration-tests:
    name: "Integration & System Tests"
    runs-on: ubuntu-latest
    container: swipl:latest
    timeout-minutes: 6
    needs: [foundation-tests, ai-tests]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: Complete Test Suite
      timeout-minutes: 2
      run: |
        echo "=== COMPLETE INTEGRATION TESTS ==="
        timeout 90s swipl -s tests/tests.pl -g "run_tests, halt." || exit 1
        echo "âœ“ Complete test suite passed"

    - name: Integration Flow Tests
      timeout-minutes: 2
      run: |
        echo "=== INTEGRATION WORKFLOW TESTS ==="
        timeout 90s swipl -s tests/tests.pl -g "run_integration_tests, halt." || exit 1
        echo "âœ“ Integration workflow completed"

  # ===================================================================
  # PHASE 5: TESTS APPLICATIFS (SÃ‰CURISÃ‰S)
  # ===================================================================
  application-tests:
    name: "Application & Module Loading Tests"
    runs-on: ubuntu-latest
    container: swipl:latest
    timeout-minutes: 4
    needs: integration-tests

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: Module Loading Validation
      timeout-minutes: 2
      run: |
        echo "=== MODULE LOADING TESTS - SAFE MODE ==="
        echo "ğŸ›¡ï¸ Protection: Triple timeout (2min â†’ 90s â†’ 30s)"

        timeout 30s swipl -s src/interface.pl -g "
          write('=== PROLOG CHESS MODULE VALIDATION ==='), nl,
          write('ğŸ“¦ Loading pieces.pl...'), nl,
          (consult('src/pieces') -> write('âœ“ pieces.pl loaded successfully') ; (write('âœ— pieces.pl failed'), halt(1))), nl,
          write('ğŸ“¦ Loading board.pl...'), nl,
          (consult('src/board') -> write('âœ“ board.pl loaded successfully') ; (write('âœ— board.pl failed'), halt(1))), nl,
          write('ğŸ“¦ Loading game.pl...'), nl,
          (consult('src/game') -> write('âœ“ game.pl loaded successfully') ; (write('âœ— game.pl failed'), halt(1))), nl,
          write('ğŸ“¦ Loading ai.pl...'), nl,
          (consult('src/ai') -> write('âœ“ ai.pl loaded successfully') ; (write('âœ— ai.pl failed'), halt(1))), nl,
          write('ğŸ¯ ALL CORE MODULES LOADED SUCCESSFULLY'), nl,
          halt(0)
        " || (echo "âŒ Module loading failed - this indicates serious issues" && exit 1)

        echo "âœ… All application modules validated successfully"

  # ===================================================================
  # PHASE 6: PERFORMANCE & QUALITÃ‰
  # ===================================================================
  quality-assurance:
    name: "Performance & Quality Metrics"
    runs-on: ubuntu-latest
    container: swipl:latest
    timeout-minutes: 3
    needs: application-tests
    if: always() # Toujours exÃ©cuter pour collecter mÃ©triques

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      timeout-minutes: 2

    - name: Performance Metrics Collection
      timeout-minutes: 1
      run: |
        echo "=== PERFORMANCE & QUALITY METRICS ==="
        echo "ğŸ“Š System Resources:"
        free -h 2>/dev/null || echo "Memory info unavailable"

        echo "ğŸ“ˆ Process Monitoring:"
        ps aux | head -10 2>/dev/null || echo "Process info unavailable"

        echo "ğŸ“ Code Metrics:"
        find src/ -name "*.pl" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print "Total lines of Prolog code: " $1}' || echo "Code metrics unavailable"

        echo "ğŸ§ª Test Coverage:"
        find tests/ -name "*.pl" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print "Total lines of test code: " $1}' || echo "Test metrics unavailable"

        echo "â±ï¸ Pipeline Duration: $(date)"
        echo "âœ… Quality assurance metrics collected"

  # ===================================================================
  # PHASE 7: DEPLOYMENT READINESS CHECK
  # ===================================================================
  deployment-readiness:
    name: "Deployment Readiness Check"
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [integration-tests, application-tests, quality-assurance]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
    - name: Deployment Validation
      run: |
        echo "=== DEPLOYMENT READINESS VALIDATION ==="
        echo "ğŸš€ Branch: ${{ github.ref }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo "âœ… All tests passed - Ready for deployment"
        echo "ğŸ¯ Prolog Chess AI - Production Ready"